<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Content Manager</title>
  <style>
    /* SOLUCIÓN DEFINITIVA PARA DUPLICACIÓN DEL PANEL */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      position: fixed;
      width: 100%;
    }
    
    #nc-root {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      overflow: hidden;
    }
    
    /* Forzar una sola instancia del CMS */
    #nc-root > div:nth-child(n+2) {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }
    
    /* Prevenir scroll en el contenedor principal */
    #nc-root > div:first-child {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      overflow: hidden !important;
    }
    
    /* Controlar el área de contenido principal */
    [class*="cms-app"], [class*="App"], [data-testid="app"] {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      overflow: hidden !important;
    }
    
    /* Sidebar fijo */
    [class*="sidebar"], [class*="Sidebar"], [data-testid="sidebar"] {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      height: 100% !important;
      z-index: 1000 !important;
      overflow-y: auto !important;
    }
    
    /* Área de contenido principal */
    [class*="main"], [class*="Main"], [class*="content"], [data-testid="main"] {
      position: fixed !important;
      top: 0 !important;
      right: 0 !important;
      height: 100% !important;
      overflow-y: auto !important;
      overflow-x: hidden !important;
    }
    
    /* Prevenir duplicación de elementos específicos */
    [data-slate-editor] {
      position: relative !important;
    }
    
    /* Ocultar elementos duplicados */
    nav:nth-of-type(n+2), 
    header:nth-of-type(n+2),
    [role="navigation"]:nth-of-type(n+2) {
      display: none !important;
    }
    
    /* Prevenir scroll en elementos padre */
    .css-1hwfws3, 
    [class*="layout"], 
    [class*="Layout"] {
      position: relative !important;
      overflow: hidden !important;
    }
    
    /* Asegurar que no hay elementos flotantes */
    * {
      box-sizing: border-box !important;
    }
    
    /* Prevenir cualquier transformación que cause duplicación */
    [class*="transform"], 
    [style*="transform"] {
      transform: none !important;
    }
  </style>
</head>
<body>
  <!-- A little help text -->
  <div id="nc-root"></div>
  

  
  <!-- Error suppression for Decap CMS 3.7.1 React DOM issues -->
  <script>
    // Suppress React DOM errors that cause UI displacement
    const originalRemoveChild = Node.prototype.removeChild;
    const originalInsertBefore = Node.prototype.insertBefore;
    const originalAppendChild = Node.prototype.appendChild;
    
    Node.prototype.removeChild = function(child) {
      try {
        return originalRemoveChild.call(this, child);
      } catch (error) {
        if (error.name === 'NotFoundError') {
          console.warn('Suppressed removeChild error (Decap CMS 3.7.1):', error.message);
          return child;
        }
        throw error;
      }
    };
    
    Node.prototype.insertBefore = function(newNode, referenceNode) {
      try {
        return originalInsertBefore.call(this, newNode, referenceNode);
      } catch (error) {
        if (error.name === 'NotFoundError') {
          console.warn('Suppressed insertBefore error (Decap CMS 3.7.1):', error.message);
          return this.appendChild(newNode);
        }
        throw error;
      }
    };
    
    // Global error handler for unhandled React errors
    window.addEventListener('error', function(event) {
      if (event.error && event.error.message && 
          (event.error.message.includes('removeChild') || 
           event.error.message.includes('insertBefore') ||
           event.error.message.includes('NotFoundError'))) {
        console.warn('Suppressed React DOM error (Decap CMS 3.7.1):', event.error.message);
        event.preventDefault();
        return false;
      }
    });
  </script>
  
  <!-- Using Decap CMS 3.6.0 - more stable version -->
  <script src="https://unpkg.com/decap-cms@3.6.0/dist/decap-cms.js"></script>
  
  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    // Polish translations for Netlify CMS
    const plTranslations = {
      auth: {
        login: 'Zaloguj się',
        loggingIn: 'Logowanie...',
        loginWithNetlifyIdentity: 'Zaloguj się przez Netlify Identity',
        loginWithBitbucket: 'Zaloguj się przez Bitbucket',
        loginWithGitHub: 'Zaloguj się przez GitHub',
        loginWithGitLab: 'Zaloguj się przez GitLab',
        errors: {
          email: 'Wprowadź swój email.',
          password: 'Wprowadź swoje hasło.',
          identitySettings: 'Nie można uzyskać dostępu do ustawień tożsamości. Podczas korzystania z git-gateway backend upewnij się, że usługa Identity i Git Gateway są włączone w Netlify.'
        }
      },
      app: {
        header: {
          content: 'Treści',
          workflow: 'Przepływ pracy',
          media: 'Media',
          quickAdd: 'Szybkie dodawanie'
        },
        app: {
          errorHeader: 'Błąd podczas ładowania konfiguracji CMS',
          configErrors: 'Błędy konfiguracji',
          checkConfigYml: 'Sprawdź plik config.yml.',
          loadingConfig: 'Ładowanie konfiguracji...',
          waitingBackend: 'Oczekiwanie na backend...'
        },
        notFoundPage: {
          header: 'Nie znaleziono'
        }
      },
      collection: {
        sidebar: {
          collections: 'Kolekcje',
          allCollections: 'Wszystkie kolekcje'
        },
        collectionTop: {
          sortBy: 'Sortuj według',
          viewAs: 'Wyświetl jako',
          newButton: 'Nowy %{collectionLabel}'
        }
      },
      editor: {
        editorControl: {
          field: {
            optional: 'opcjonalne'
          }
        },
        editorControlPane: {
          widget: {
            required: '%{fieldLabel} jest wymagane.'
          }
        }
      },
      mediaLibrary: {
        mediaLibraryCard: {
          draft: 'Szkic'
        },
        mediaLibrary: {
          onDeleteTitle: 'Usunąć wybrane media?'
        }
      },
      ui: {
        default: {
          goBackToSite: 'Wróć do strony'
        },
        toast: {
          entrySaved: 'Wpis zapisany',
          entryPublished: 'Wpis opublikowany'
        }
      }
    };

    // SOLUCIÓN DEFINITIVA PARA DUPLICACIÓN - JavaScript mejorado
    document.addEventListener('DOMContentLoaded', function() {
      // Suprimir errores de React DOM
      const originalConsoleError = console.error;
      console.error = function(...args) {
        const message = args.join(' ');
        if (message.includes('removeChild') || 
            message.includes('insertBefore') || 
            message.includes('NotFoundError') ||
            message.includes('Warning: ReactDOM.render')) {
          console.warn('Error React DOM suprimido:', message);
          return;
        }
        originalConsoleError.apply(console, args);
      };
      
      // Control estricto de inicialización
      let cmsInitialized = false;
      let initializationAttempts = 0;
      const MAX_ATTEMPTS = 3;
      
      // Limpiar completamente el contenedor
      function forceClearRoot() {
        const root = document.getElementById('nc-root');
        if (root) {
          root.innerHTML = '';
          // Remover todos los event listeners
          const newRoot = root.cloneNode(false);
          root.parentNode.replaceChild(newRoot, root);
        }
      }
      
      // Prevenir duplicación agresiva
      function preventDuplication() {
        const root = document.getElementById('nc-root');
        if (!root) return;
        
        // Observer para eliminar duplicados inmediatamente
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
              const children = Array.from(root.children);
              if (children.length > 1) {
                // Eliminar todos excepto el primero
                children.slice(1).forEach(child => {
                  try {
                    root.removeChild(child);
                  } catch (e) {
                    // Ignorar errores de eliminación
                  }
                });
              }
            }
          });
        });
        
        observer.observe(root, { 
          childList: true, 
          subtree: false,
          attributes: false 
        });
        
        // Verificación periódica adicional
        setInterval(() => {
          const children = Array.from(root.children);
          if (children.length > 1) {
            children.slice(1).forEach(child => {
              try {
                root.removeChild(child);
              } catch (e) {
                // Ignorar errores
              }
            });
          }
        }, 500);
      }
      
      // Inicializar CMS con control estricto
      function initializeCMS() {
        if (cmsInitialized || initializationAttempts >= MAX_ATTEMPTS) {
          return;
        }
        
        initializationAttempts++;
        
        try {
          if (window.CMS) {
            // Limpiar antes de inicializar
            forceClearRoot();
            
            // Registrar idioma y inicializar
            CMS.registerLocale('pl', plTranslations);
            CMS.init();
            
            cmsInitialized = true;
            console.log('Decap CMS inicializado correctamente - Intento:', initializationAttempts);
            
            // Activar prevención de duplicación
            setTimeout(preventDuplication, 100);
            
          } else {
            // Reintentar si CMS no está disponible
            setTimeout(initializeCMS, 500);
          }
        } catch (error) {
          console.warn('Error de inicialización CMS suprimido:', error.message);
          if (initializationAttempts < MAX_ATTEMPTS) {
            setTimeout(initializeCMS, 1000);
          }
        }
      }
      
      // Inicializar inmediatamente
      initializeCMS();

      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", user => {
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              document.location.href = "/admin/";
            });
          }
        });
      }
    });
  </script>